// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(STUDENT)
  collegeId String?  // For FACULTY_LEADER and DEAN_OF_FACULTY roles
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // Track who created this user (for admin panel)

  // Relations
  createdCommunities Community[]       @relation("CommunityCreator")
  memberships        CommunityMember[]
  createdEvents      Event[]           @relation("EventCreator")
  adminPreferences   AdminPreference?
  college            College?          @relation(fields: [collegeId], references: [id], onDelete: SetNull)
  notifications      Notification[]

  @@map("users")
}

model AdminPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  activeSection String   @default("communities") // Last active section in admin panel
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_preferences")
}

model Community {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  avatar      String   // Emoji
  color       String
  collegeId   String?  // Optional for migration, will be required later
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String
  
  // Relations
  creator     User              @relation("CommunityCreator", fields: [createdBy], references: [id])
  college     College?          @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  members     CommunityMember[]
  events      Event[]

  @@map("communities")
}

model CommunityMember {
  id          String   @id @default(cuid())
  userId      String
  communityId String
  joinedAt    DateTime @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@map("community_members")
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String
  location    String    // Keep for backward compatibility
  startDate   DateTime
  endDate     DateTime?
  communityId String?
  collegeId   String?   // New: Reference to College
  locationId  String?   // New: Reference to Location
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Approval workflow
  status                      EventStatus @default(PENDING_FACULTY_APPROVAL)
  facultyLeaderApproval       ApprovalStatus @default(PENDING)
  facultyLeaderApprovedBy     String?
  facultyLeaderApprovedAt     DateTime?
  deanOfFacultyApproval       ApprovalStatus @default(PENDING)
  deanOfFacultyApprovedBy     String?
  deanOfFacultyApprovedAt     DateTime?
  deanshipApproval            ApprovalStatus @default(PENDING)
  deanshipApprovedBy          String?
  deanshipApprovedAt          DateTime?
  
  // Relations
  creator       User          @relation("EventCreator", fields: [createdBy], references: [id])
  community     Community?    @relation(fields: [communityId], references: [id], onDelete: SetNull)
  college       College?      @relation(fields: [collegeId], references: [id], onDelete: SetNull)
  eventLocation Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  notifications Notification[]

  @@map("events")
}

enum EventStatus {
  PENDING_FACULTY_APPROVAL
  PENDING_DEAN_APPROVAL
  PENDING_DEANSHIP_APPROVAL
  APPROVED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model College {
  id        String     @id @default(cuid())
  name      String     @unique
  code      String     @unique // e.g., "ENG", "BUS", "IT"
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  // Relations
  locations    Location[]
  events       Event[]
  communities  Community[]
  users        User[]      // Faculty leaders and deans assigned to this college

  @@map("colleges")
}

model Location {
  id         String   @id @default(cuid())
  name       String
  capacity   Int?     // Optional: maximum capacity
  collegeId  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  events  Event[]

  @@map("locations")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  type      NotificationType
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationType {
  EVENT_PENDING_APPROVAL
  EVENT_APPROVED
  EVENT_REJECTED
}

enum Role {
  STUDENT
  CLUB_LEADER
  FACULTY_LEADER
  DEAN_OF_FACULTY
  DEANSHIP_OF_STUDENT_AFFAIRS
  ADMIN
}

model ApplicationForm {
  id            String   @id @default(cuid())
  userId        String
  communityId   String
  name          String
  studentNumber String
  age           Int
  major         String
  phoneNumber   String
  city          String
  status        ApplicationStatus @default(PENDING)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("application_forms")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}
