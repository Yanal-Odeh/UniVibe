// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(STUDENT)
  collegeId String?  // For FACULTY_LEADER and DEAN_OF_FACULTY roles
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // Track who created this user (for admin panel)

  // Relations
  createdCommunities Community[]       @relation("CommunityCreator")
  ledCommunities     Community[]       @relation("CommunityClubLeader")
  memberships        CommunityMember[]
  createdEvents      Event[]              @relation("EventCreator")
  adminPreferences   AdminPreference?
  college            College?             @relation(fields: [collegeId], references: [id], onDelete: SetNull)
  notifications      Notification[]
  eventRegistrations EventRegistration[]
  savedEvents        SavedEvent[]
  applications       ApplicationForm[]  @relation("UserApplications")
  studySpaceReservations StudySpaceReservation[]
  tasksAssignedTo    Task[]             @relation("TasksAssignedTo")
  tasksAssignedBy    Task[]             @relation("TasksAssignedBy")
  uploadedMedia      EventMedia[]       @relation("MediaUploader")

  // Performance indexes
  @@index([role, collegeId]) // For finding faculty/dean by college
  @@index([email]) // Already unique, but explicit for auth queries
  @@map("users")
}

model AdminPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  activeSection String   @default("communities") // Last active section in admin panel
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admin_preferences")
}

model Community {
  id            String   @id @default(cuid())
  name          String   @unique
  description   String
  avatar        String   // Emoji
  color         String
  collegeId     String?  // Optional for migration, will be required later
  clubLeaderId  String?  // Club leader assigned to this community
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String
  
  // Relations
  creator       User              @relation("CommunityCreator", fields: [createdBy], references: [id])
  clubLeader    User?             @relation("CommunityClubLeader", fields: [clubLeaderId], references: [id], onDelete: SetNull)
  college       College?          @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  members       CommunityMember[]
  events        Event[]
  applications  ApplicationForm[] @relation("CommunityApplications")

  @@map("communities")
}

model CommunityMember {
  id          String   @id @default(cuid())
  userId      String
  communityId String
  joinedAt    DateTime @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@map("community_members")
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String
  location    String    // Keep for backward compatibility
  startDate   DateTime
  endDate     DateTime?
  communityId String?
  collegeId   String?   // New: Reference to College
  locationId  String?   // New: Reference to Location
  capacity    Int?      // Maximum number of attendees
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Approval workflow
  status                      EventStatus @default(PENDING_FACULTY_APPROVAL)
  facultyLeaderApproval       ApprovalStatus @default(PENDING)
  facultyLeaderApprovedBy     String?
  facultyLeaderApprovedAt     DateTime?
  facultyLeaderRejectionReason String?
  deanOfFacultyApproval       ApprovalStatus @default(PENDING)
  deanOfFacultyApprovedBy     String?
  deanOfFacultyApprovedAt     DateTime?
  deanOfFacultyRejectionReason String?
  deanOfFacultyRevisionMessage String? // Dean's message when sending back for revision
  facultyLeaderRevisionResponse String? // Faculty leader's response to dean's revision request
  deanshipApproval            ApprovalStatus @default(PENDING)
  deanshipApprovedBy          String?
  deanshipApprovedAt          DateTime?
  deanshipRejectionReason     String?
  deanshipRevisionMessage     String? // Deanship's message when sending back for revision
  deanOfFacultyRevisionResponse String? // Dean's response to deanship's revision request
  
  // Relations
  creator       User               @relation("EventCreator", fields: [createdBy], references: [id])
  community     Community?         @relation(fields: [communityId], references: [id], onDelete: SetNull)
  college       College?           @relation(fields: [collegeId], references: [id], onDelete: SetNull)
  eventLocation Location?          @relation(fields: [locationId], references: [id], onDelete: SetNull)
  notifications Notification[]
  registrations EventRegistration[]
  savedByUsers  SavedEvent[]
  tasks         Task[]
  media         EventMedia[]

  // Performance indexes
  @@index([status, startDate]) // Already exists - for filtering approved/pending events by date
  @@index([communityId]) // Already exists
  @@index([collegeId]) // Already exists  
  @@index([createdBy]) // Already exists
  @@index([status, collegeId]) // For college-specific approval queries
  @@index([facultyLeaderApproval, collegeId]) // For faculty leader pending approvals
  @@index([deanOfFacultyApproval, collegeId]) // For dean pending approvals
  @@index([deanshipApproval]) // For deanship pending approvals
  @@map("events")
}

enum EventStatus {
  PENDING_FACULTY_APPROVAL
  PENDING_DEAN_APPROVAL
  NEEDS_REVISION_DEAN  // Dean sent event back for revision to faculty leader
  PENDING_DEANSHIP_APPROVAL
  NEEDS_REVISION_DEANSHIP  // Deanship sent event back for revision to dean
  APPROVED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model College {
  id        String     @id @default(cuid())
  name      String     @unique
  code      String     @unique // e.g., "ENG", "BUS", "IT"
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  // Relations
  locations    Location[]
  events       Event[]
  communities  Community[]
  users        User[]      // Faculty leaders and deans assigned to this college

  // Performance index
  @@index([code]) // For quick lookups by college code
  @@map("colleges")
}

model Location {
  id         String   @id @default(cuid())
  name       String
  capacity   Int?     // Optional: maximum capacity
  collegeId  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  events  Event[]

  @@map("locations")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  eventId   String?
  type      NotificationType
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event? @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId, read]) // For fetching unread notifications per user
  @@index([eventId]) // For event-related notification queries
  @@index([userId, createdAt]) // For chronological user notifications
  @@map("notifications")
}

enum NotificationType {
  EVENT_PENDING_APPROVAL
  EVENT_APPROVED
  EVENT_NEEDS_REVISION  // Dean sent event back for revision
  EVENT_REJECTED
  EVENT_REMINDER_1_DAY
  EVENT_REMINDER_1_HOUR
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  STUDY_SPACE_RESERVED
  STUDY_SPACE_CANCELLED
}

enum Role {
  STUDENT
  CLUB_LEADER
  FACULTY_LEADER
  DEAN_OF_FACULTY
  DEANSHIP_OF_STUDENT_AFFAIRS
  ADMIN
}

model ApplicationForm {
  id            String   @id @default(cuid())
  userId        String
  communityId   String
  name          String
  studentNumber String
  age           Int
  major         String
  phoneNumber   String
  city          String
  status        ApplicationStatus @default(PENDING)
  rejectionReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user      User      @relation("UserApplications", fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation("CommunityApplications", fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@map("application_forms")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model EventRegistration {
  id           String   @id @default(cuid())
  userId       String
  eventId      String
  registeredAt DateTime @default(now())
  
  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

model SavedEvent {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  savedAt   DateTime @default(now())
  
  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("saved_events")
}

model StudySpace {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String   // 'quiet', 'collaborative', 'cafe'
  description String
  capacity    Int      // Total number of seats
  location    String
  hours       String
  amenities   String[] // Array of amenity strings
  image       String   // Emoji representation
  color       String   // Hex color code
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  reservations StudySpaceReservation[]

  @@map("study_spaces")
}

model StudySpaceReservation {
  id          String   @id @default(cuid())
  studentId   String
  spaceId     String
  date        DateTime @db.Date // Reservation date
  timeSlot    String   // e.g., "09:00", "14:00"
  status      ReservationStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  student     User       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([spaceId, date, status]) // For checking capacity per day
  @@index([studentId, status]) // For fetching user's active reservations
  @@index([date, status]) // For daily reset queries
  @@map("study_space_reservations")
}

enum ReservationStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  eventId     String
  assignedToId String
  assignedById String  // Club leader who assigned the task
  status      TaskStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  event       Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  assignedTo  User  @relation("TasksAssignedTo", fields: [assignedToId], references: [id], onDelete: Cascade)
  assignedBy  User  @relation("TasksAssignedBy", fields: [assignedById], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([assignedToId])
  @@index([assignedById])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model EventMedia {
  id          String   @id @default(cuid())
  eventId     String
  fileUrl     String   // Path to the uploaded file
  fileType    MediaType // IMAGE or VIDEO
  fileName    String   // Original file name
  fileSize    Int      // File size in bytes
  uploadedBy  String   // User who uploaded the media
  createdAt   DateTime @default(now())
  
  // Relations
  event       Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  uploader    User  @relation("MediaUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([uploadedBy])
  @@map("event_media")
}

enum MediaType {
  IMAGE
  VIDEO
}